<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Cobranza - Multitenancy</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    /* üîê PANTALLA DE LOGIN */
    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: white;
      padding: 50px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 450px;
      width: 100%;
    }

    .login-box h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2em;
    }

    .login-box p {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }

    .login-form .form-group {
      margin-bottom: 20px;
    }

    .login-form label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .login-form input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 1em;
      transition: all 0.3s;
    }

    .login-form input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .login-error {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      border-left: 4px solid #ef4444;
    }

    .main-screen {
      display: none;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header h1 {
      font-size: 2em;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(255,255,255,0.2);
      padding: 10px 20px;
      border-radius: 10px;
    }

    .credits {
      font-size: 1.2em;
      font-weight: bold;
    }

    .user-badge {
      background: rgba(255,255,255,0.3);
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .tenant-indicator {
      background: rgba(255,255,255,0.15);
      padding: 8px 15px;
      border-radius: 8px;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 2px solid #e9ecef;
      overflow-x: auto;
    }

    .tab {
      padding: 15px 30px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 1em;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .tab.active {
      background: white;
      color: #667eea;
      border-bottom: 3px solid #667eea;
    }

    .tab-content {
      display: none;
      padding: 30px;
    }

    .tab-content.active {
      display: block;
    }

    .section {
      margin-bottom: 30px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 15px;
      border: 2px solid #e9ecef;
    }

    .section h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5em;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1em;
      font-family: inherit;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .variable-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .variable-tag {
      padding: 5px 12px;
      background: #667eea;
      color: white;
      border-radius: 5px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s;
    }

    .variable-tag:hover {
      background: #5568d3;
      transform: scale(1.05);
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-full {
      width: 100%;
      justify-content: center;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .stat-number {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-number.success { color: #10b981; }
    .stat-number.error { color: #ef4444; }
    .stat-number.pending { color: #f59e0b; }
    .stat-number.total { color: #667eea; }

    .stat-label {
      color: #666;
      font-size: 0.9em;
    }

    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .log-container {
      max-height: 400px;
      overflow-y: auto;
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
    }

    .log-entry {
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .log-success {
      background: #d1fae5;
      color: #065f46;
      border-left: 4px solid #10b981;
    }

    .log-error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid #ef4444;
    }

    .log-info {
      background: #dbeafe;
      color: #1e40af;
      border-left: 4px solid #3b82f6;
    }

    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e5e7eb;
      border-radius: 15px;
      overflow: hidden;
      margin-top: 15px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9em;
    }

    .two-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .two-columns {
        grid-template-columns: 1fr;
      }
    }

    canvas {
      max-width: 100%;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      display: inline-block;
      padding: 15px 30px;
      background: #667eea;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: all 0.3s;
    }

    .file-input-label:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .template-preview {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border: 2px dashed #e9ecef;
    }

    .template-preview h4 {
      margin-bottom: 10px;
      color: #667eea;
    }

    .admin-only {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .user-table {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 15px;
    }

    .user-row {
      padding: 15px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-row:last-child {
      border-bottom: none;
    }

    .user-details {
      flex: 1;
    }

    .user-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .user-meta {
      font-size: 0.9em;
      color: #666;
    }

    .user-actions {
      display: flex;
      gap: 10px;
    }

    .password-toggle {
      position: relative;
    }

    .password-toggle input {
      padding-right: 45px;
    }

    .password-toggle-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      font-size: 1.2em;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 3em;
      margin-bottom: 15px;
    }

    .info-banner {
      background: #e0e7ff;
      border-left: 4px solid #667eea;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .template-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 2px solid #e9ecef;
      transition: all 0.3s;
    }

    .template-card:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .template-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .template-meta {
      font-size: 0.85em;
      color: #666;
      margin-top: 5px;
    }

    .admin-view-toggle {
      background: rgba(255,255,255,0.2);
      padding: 8px 15px;
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s;
    }

    .admin-view-toggle:hover {
      background: rgba(255,255,255,0.3);
    }
  </style>
</head>
<body>
  <!-- üîê PANTALLA DE LOGIN -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>üîê Sistema de Cobranza</h1>
      <p>Ingresa tus credenciales para continuar</p>
      
      <div class="login-error" id="loginError"></div>
      
      <form class="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>üë§ Usuario</label>
          <input type="text" id="loginUsername" placeholder="Ingresa tu usuario" required>
        </div>
        
        <div class="form-group password-toggle">
          <label>üîí Contrase√±a</label>
          <input type="password" id="loginPassword" placeholder="Ingresa tu contrase√±a" required>
          <button type="button" class="password-toggle-btn" onclick="togglePassword('loginPassword')">üëÅÔ∏è</button>
        </div>
        
        <button type="submit" class="btn btn-primary btn-full">Iniciar Sesi√≥n</button>
      </form>
    </div>
  </div>

  <!-- üìä PANTALLA PRINCIPAL -->
  <div class="main-screen" id="mainScreen">
    <div class="container">
      <div class="header">
        <div>
          <h1>üì± Sistema de Cobranza</h1>
          <div class="tenant-indicator" id="tenantIndicator">
            üè¢ Espacio Personal
          </div>
        </div>
        <div class="user-info">
          <div>
            <div id="userName">Usuario</div>
            <span class="user-badge" id="userRole">Usuario</span>
            <div class="credits">üí≥ <span id="userCredits">0</span> cr√©ditos</div>
          </div>
          <button class="btn btn-danger" onclick="logout()">Salir</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('campaign')">üìä Campa√±as</button>
        <button class="tab" onclick="switchTab('templates')">üìù Plantillas</button>
        <button class="tab" onclick="switchTab('stats')">üìà Estad√≠sticas</button>
        <button class="tab" onclick="switchTab('admin')" id="adminTab" style="display:none">‚öôÔ∏è Administraci√≥n</button>
      </div>

      <!-- TAB: CAMPA√ëAS -->
      <div class="tab-content active" id="campaign">
        <div class="info-banner">
          <span style="font-size: 1.5em;">‚ÑπÔ∏è</span>
          <div>
            <strong>Espacio Personal:</strong> Tus campa√±as y datos son privados. Solo t√∫ y los administradores pueden verlos.
          </div>
        </div>

        <div class="section">
          <h2>üìÇ Cargar Clientes</h2>
          <div class="file-input-wrapper">
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
            <label for="fileInput" class="file-input-label">üìÑ Seleccionar Archivo CSV/Excel</label>
          </div>
          <div id="fileName" style="margin-top: 10px; color: #666;"></div>
        </div>

        <div class="section">
          <h2>üöÄ Configurar Campa√±a</h2>
          <div class="form-group">
            <label>Plantilla a usar:</label>
            <select id="templateSelect">
              <option value="">Seleccionar plantilla...</option>
            </select>
          </div>
          <div class="two-columns">
            <button class="btn btn-success" onclick="startCampaign('sms')" id="btnSMS" disabled>üì± Enviar SMS</button>
            <button class="btn btn-warning" onclick="startCampaign('call')" id="btnCall" disabled>üìû Hacer Llamadas</button>
          </div>
          <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill">0%</div>
          </div>
        </div>

        <div class="section">
          <h2>üìä Registro de Actividad</h2>
          <div class="log-container" id="logContainer">
            <div class="log-entry log-info">‚ÑπÔ∏è Sistema iniciado - Espacio personal activo</div>
          </div>
        </div>
      </div>

      <!-- TAB: PLANTILLAS -->
      <div class="tab-content" id="templates">
        <div class="info-banner">
          <span style="font-size: 1.5em;">üìù</span>
          <div>
            <strong>Plantillas Personales:</strong> Crea y administra tus propias plantillas. No se mezclar√°n con las de otros usuarios.
          </div>
        </div>

        <div class="section">
          <h2>üìù Crear Nueva Plantilla</h2>
          <div class="form-group">
            <label>Nombre de la Compa√±√≠a:</label>
            <input type="text" id="companyName" placeholder="Ej: Banco Nacional">
          </div>
          <div class="form-group">
            <label>Nombre de la Plantilla:</label>
            <input type="text" id="templateName" placeholder="Ej: Recordatorio Pago Vencido">
          </div>
          <div class="form-group">
            <label>Mensaje SMS:</label>
            <textarea id="smsMessage" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
            <div class="variable-tags">
              <span class="variable-tag" onclick="insertVariable('smsMessage', '{Nombre}')">üë§ {Nombre}</span>
              <span class="variable-tag" onclick="insertVariable('smsMessage', '{Telefono}')">üì± {Telefono}</span>
              <span class="variable-tag" onclick="insertVariable('smsMessage', '{Deuda}')">üí∞ {Deuda}</span>
              <span class="variable-tag" onclick="insertVariable('smsMessage', '{Compa√±ia}')">üè¢ {Compa√±ia}</span>
            </div>
          </div>
          <div class="form-group">
            <label>Script de Llamada:</label>
            <textarea id="callScript" placeholder="Escribe el script para la llamada..."></textarea>
            <div class="variable-tags">
              <span class="variable-tag" onclick="insertVariable('callScript', '{Nombre}')">üë§ {Nombre}</span>
              <span class="variable-tag" onclick="insertVariable('callScript', '{Telefono}')">üì± {Telefono}</span>
              <span class="variable-tag" onclick="insertVariable('callScript', '{Deuda}')">üí∞ {Deuda}</span>
              <span class="variable-tag" onclick="insertVariable('callScript', '{Compa√±ia}')">üè¢ {Compa√±ia}</span>
            </div>
          </div>
          <button class="btn btn-primary" onclick="saveTemplate()">üíæ Guardar Plantilla</button>
        </div>

        <div class="section">
          <h2>üìã Mis Plantillas</h2>
          <div id="templatesList"></div>
        </div>
      </div>

      <!-- TAB: ESTAD√çSTICAS -->
      <div class="tab-content" id="stats">
        <div class="info-banner">
          <span style="font-size: 1.5em;">üìà</span>
          <div>
            <strong>Estad√≠sticas Personales:</strong> Estas m√©tricas reflejan √∫nicamente tus campa√±as.
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number total" id="statTotal">0</div>
            <div class="stat-label">Total Enviados</div>
          </div>
          <div class="stat-card">
            <div class="stat-number success" id="statSuccess">0</div>
            <div class="stat-label">Exitosos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number error" id="statErrors">0</div>
            <div class="stat-label">Errores</div>
          </div>
          <div class="stat-card">
            <div class="stat-number pending" id="statPending">0</div>
            <div class="stat-label">Pendientes</div>
          </div>
        </div>

        <div class="chart-container">
          <h2>üìä Gr√°fica de Resultados</h2>
          <canvas id="statsChart"></canvas>
        </div>

        <div class="section">
          <h2>üìû Detalle de Llamadas</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number success" id="callAnswered">0</div>
              <div class="stat-label">Contestadas</div>
            </div>
            <div class="stat-card">
              <div class="stat-number error" id="callRejected">0</div>
              <div class="stat-label">Rechazadas</div>
            </div>
            <div class="stat-card">
              <div class="stat-number pending" id="callBusy">0</div>
              <div class="stat-label">Ocupado</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="callNoAnswer">0</div>
              <div class="stat-label">No Contest√≥</div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: ADMINISTRACI√ìN -->
      <div class="tab-content" id="admin">
        <div class="admin-only">
          <strong>‚ö†Ô∏è Panel de Administrador</strong> - Tienes acceso completo a todos los usuarios y sus datos.
        </div>

        <!-- Vista Global de Admin -->
        <div class="section" id="adminGlobalView">
          <h2>üåê Vista Global del Sistema</h2>
          <div class="admin-view-toggle" onclick="toggleAdminView()">
            <span id="adminViewText">üëÅÔ∏è Ver todas las plantillas de usuarios</span>
          </div>
          <div id="allTemplatesView" style="display:none; margin-top: 20px;"></div>
          <div id="allStatsView" style="display:none; margin-top: 20px;"></div>
        </div>

        <div class="section">
          <h2>üë• Crear Nuevo Usuario</h2>
          <div class="form-group">
            <label>Nombre de Usuario:</label>
            <input type="text" id="newUserName" placeholder="Nombre del usuario">
          </div>
          <div class="form-group">
            <label>Email:</label>
            <input type="email" id="newUserEmail" placeholder="email@ejemplo.com">
          </div>
          <div class="form-group password-toggle">
            <label>Contrase√±a:</label>
            <input type="password" id="newUserPassword" placeholder="Contrase√±a segura">
            <button type="button" class="password-toggle-btn" onclick="togglePassword('newUserPassword')">üëÅÔ∏è</button>
          </div>
          <div class="form-group">
            <label>Cr√©ditos Iniciales:</label>
            <input type="number" id="newUserCredits" value="100">
          </div>
          <div class="form-group">
            <label>Rol:</label>
            <select id="newUserRole">
              <option value="user">Usuario</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="createUser()">‚ûï Crear Usuario</button>
        </div>

        <div class="section">
          <h2>üë§ Lista de Usuarios</h2>
          <div class="user-table" id="usersList"></div>
        </div>

        <div class="section">
          <h2>üí≥ Asignar Cr√©ditos</h2>
          <div class="form-group">
            <label>Usuario:</label>
            <select id="creditUserId"></select>
          </div>
          <div class="form-group">
            <label>Cantidad de Cr√©ditos:</label>
            <input type="number" id="creditAmount" value="50">
          </div>
          <button class="btn btn-success" onclick="assignCredits()">üí∞ Asignar Cr√©ditos</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    // üåê API Base URL
    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000/api' 
      : `${window.location.origin}/api`;

    let clientsData = [];
    let currentUser = null;
    let users = [];
    let adminViewExpanded = false;

    // üè¢ SISTEMA MULTITENANCY - Datos por usuario
    const STORAGE_KEYS = {
      users: 'system_users',
      templates: (username) => `templates_${username}`,
      stats: (username) => `stats_${username}`,
      logs: (username) => `logs_${username}`
    };

    // üîê SISTEMA DE AUTENTICACI√ìN
    function initializeSystem() {
      const savedUsers = localStorage.getItem(STORAGE_KEYS.users);
      if (savedUsers) {
        users = JSON.parse(savedUsers);
      } else {
        users = [{
          id: 1,
          username: 'admin',
          password: 'admin123',
          name: 'SuperAdministrador',
          email: 'admin@sistema.com',
          credits: 1000,
          role: 'admin',
          createdAt: new Date().toISOString()
        }];
        saveUsers();
        console.log('‚ö†Ô∏è Usuario admin creado. Usuario: admin | Contrase√±a: admin123');
      }

      const sessionUser = sessionStorage.getItem('current_user');
      if (sessionUser) {
        currentUser = JSON.parse(sessionUser);
        showMainScreen();
      } else {
        showLoginScreen();
      }
    }

    function handleLogin(event) {
      event.preventDefault();
      
      const username = document.getElementById('loginUsername').value.trim();
      const password =
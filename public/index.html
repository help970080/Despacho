<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Cobranza - MongoDB + Scheduler</title>
  <!-- LibrerÃ­a para exportar Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    /* LOGIN */
    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: white;
      padding: 50px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 450px;
      width: 100%;
    }

    .login-box h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2em;
    }

    .login-box p {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }

    .login-form .form-group {
      margin-bottom: 20px;
    }

    .login-form label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .login-form input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 1em;
      transition: all 0.3s;
    }

    .login-form input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .login-error {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      border-left: 4px solid #ef4444;
    }

    .main-screen {
      display: none;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header h1 {
      font-size: 2em;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(255,255,255,0.2);
      padding: 10px 20px;
      border-radius: 10px;
    }

    .credits {
      font-size: 1.2em;
      font-weight: bold;
    }

    .user-badge {
      background: rgba(255,255,255,0.3);
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 2px solid #e9ecef;
      overflow-x: auto;
    }

    .tab {
      padding: 15px 30px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 1em;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .tab.active {
      background: white;
      color: #667eea;
      border-bottom: 3px solid #667eea;
    }

    .tab-content {
      display: none;
      padding: 30px;
    }

    .tab-content.active {
      display: block;
    }

    .section {
      margin-bottom: 30px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 15px;
      border: 2px solid #e9ecef;
    }

    .section h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5em;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1em;
      font-family: inherit;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .two-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .three-columns {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 968px) {
      .three-columns {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .two-columns,
      .three-columns {
        grid-template-columns: 1fr;
      }
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    .btn-warning:hover {
      background: #d97706;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
    }

    .btn-full {
      width: 100%;
      justify-content: center;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border-left: 4px solid;
    }

    .stat-card.total { border-color: #667eea; }
    .stat-card.success { border-color: #10b981; }
    .stat-card.error { border-color: #ef4444; }
    .stat-card.pending { border-color: #f59e0b; }

    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      margin: 10px 0;
    }

    .stat-label {
      color: #666;
      font-size: 0.9em;
      font-weight: 600;
    }

    .client-card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
    }

    .client-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    .client-name {
      font-weight: bold;
      font-size: 1.1em;
      color: #333;
    }

    .client-info {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .client-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .client-actions button {
      padding: 8px 15px;
      font-size: 0.9em;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }

    .status-pending { background: #fef3c7; color: #92400e; }
    .status-contacted { background: #dbeafe; color: #1e40af; }
    .status-promised { background: #e0e7ff; color: #4338ca; }
    .status-paid { background: #d1fae5; color: #065f46; }
    .status-dispute { background: #fee2e2; color: #991b1b; }
    .status-scheduled { background: #fef3c7; color: #92400e; }
    .status-running { background: #dbeafe; color: #1e40af; }
    .status-completed { background: #d1fae5; color: #065f46; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }

    .template-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #10b981;
    }

    .template-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .template-title {
      font-weight: bold;
      font-size: 1.2em;
      color: #333;
    }

    .template-company {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .template-content {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .template-content h4 {
      color: #667eea;
      margin-bottom: 8px;
      font-size: 0.9em;
    }

    .template-content p {
      color: #333;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .template-actions {
      display: flex;
      gap: 10px;
    }

    .campaign-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }

    .campaign-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .campaign-title {
      font-weight: bold;
      font-size: 1.2em;
      color: #333;
    }

    .campaign-meta {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .campaign-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }

    .campaign-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .log-container {
      background: #1e293b;
      padding: 20px;
      border-radius: 10px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .log-entry {
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 5px;
      border-left: 3px solid;
    }

    .log-info {
      background: rgba(59, 130, 246, 0.1);
      color: #60a5fa;
      border-color: #3b82f6;
    }

    .log-success {
      background: rgba(34, 197, 94, 0.1);
      color: #4ade80;
      border-color: #22c55e;
    }

    .log-error {
      background: rgba(239, 68, 68, 0.1);
      color: #f87171;
      border-color: #ef4444;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 4em;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 2px solid #e9ecef;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .filter-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .info-box {
      background: #e0e7ff;
      border-left: 4px solid #4f46e5;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      color: #3730a3;
    }

    .info-box strong {
      display: block;
      margin-bottom: 5px;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    /* Scrollbar personalizado */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #5568d3;
    }

    /* AnimaciÃ³n de carga */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <!-- PANTALLA DE LOGIN -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>ð Sistema de Cobranza</h1>
      <p>MongoDB + Scheduler</p>
      
      <div class="login-error" id="loginError"></div>
      
      <form class="login-form" onsubmit="login(event)">
        <div class="form-group">
          <label>Usuario</label>
          <input type="text" id="loginUsername" required autocomplete="username">
        </div>
        
        <div class="form-group">
          <label>ContraseÃ±a</label>
          <input type="password" id="loginPassword" required autocomplete="current-password">
        </div>
        
        <button type="submit" class="btn btn-primary btn-full">
          ð Iniciar SesiÃ³n
        </button>
      </form>

      <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef; text-align: center; color: #666; font-size: 0.9em;">
        <strong>Usuario de prueba:</strong><br>
        Usuario: <code style="background: #f3f4f6; padding: 2px 8px; border-radius: 4px;">admin</code><br>
        ContraseÃ±a: <code style="background: #f3f4f6; padding: 2px 8px; border-radius: 4px;">admin123</code>
      </div>
    </div>
  </div>

  <!-- PANTALLA PRINCIPAL -->
  <div class="main-screen" id="mainScreen">
    <div class="container">
      <!-- HEADER -->
      <div class="header">
        <h1>ð Sistema de Cobranza</h1>
        <div class="user-info">
          <span id="userName"></span>
          <span class="user-badge" id="userRole"></span>
          <span class="credits">ð³ <span id="userCredits">0</span></span>
          <button class="btn btn-danger" onclick="logout()" style="padding: 8px 15px;">
            ðª Salir
          </button>
        </div>
      </div>

      <!-- TABS -->
      <div class="tabs">
        <button class="tab active" onclick="showTab('dashboard')">ð Dashboard</button>
        <button class="tab" onclick="showTab('campaigns')">ð± CampaÃ±as</button>
        <button class="tab" onclick="showTab('templates')">ð Plantillas</button>
        <button class="tab" onclick="showTab('scheduler')">â° Programar</button>
        <button class="tab" onclick="showTab('clients')">ð¥ Clientes</button>
        <button class="tab" onclick="showTab('stats')">ð EstadÃ­sticas</button>
        <button class="tab" onclick="showTab('logs')">ð Logs</button>
        <button class="tab admin-only" onclick="showTab('admin')" style="display: none;">âï¸ Admin</button>
      </div>

      <!-- ð DASHBOARD -->
      <div class="tab-content active" id="tab-dashboard">
        <h2 style="color: #667eea; margin-bottom: 20px;">ð Panel de Control</h2>
        
        <div class="stats-grid">
          <div class="stat-card total">
            <div class="stat-label">Total Enviados</div>
            <div class="stat-value" id="statTotal">0</div>
          </div>
          <div class="stat-card success">
            <div class="stat-label">Exitosos</div>
            <div class="stat-value" id="statSuccess">0</div>
          </div>
          <div class="stat-card error">
            <div class="stat-label">Errores</div>
            <div class="stat-value" id="statErrors">0</div>
          </div>
          <div class="stat-card pending">
            <div class="stat-label">Pendientes</div>
            <div class="stat-value" id="statPending">0</div>
          </div>
        </div>

        <div class="section">
          <h2>ð Actividad Reciente</h2>
          <div class="log-container" id="dashboardLogs">
            <div class="log-entry log-info">â¹ï¸ Sistema iniciado</div>
          </div>
        </div>
      </div>

      <!-- ð± CAMPAÃAS -->
      <div class="tab-content" id="tab-campaigns">
        <h2 style="color: #667eea; margin-bottom: 20px;">ð± GestiÃ³n de CampaÃ±as</h2>

        <div class="section">
          <h2>ð Cargar Clientes</h2>
          <div class="info-box">
            <strong>ð Formato del CSV:</strong>
            El archivo debe contener las columnas: Nombre, Telefono, Deuda, CompaÃ±ia
          </div>
          <input type="file" id="csvFile" accept=".csv" style="margin-bottom: 15px;">
          <button class="btn btn-primary" onclick="loadCSV()">
            ð¥ Cargar CSV
          </button>
        </div>

        <div class="section">
          <h2>ð¥ Clientes Cargados (<span id="clientCount">0</span>)</h2>
          <div id="clientsList">
            <div class="empty-state">
              <div class="empty-state-icon">ð</div>
              <p>No hay clientes cargados</p>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>ð Enviar CampaÃ±a</h2>
          <div class="form-group">
            <label>Seleccionar Plantilla</label>
            <select id="campaignTemplate">
              <option value="">-- Selecciona una plantilla --</option>
            </select>
          </div>
          <div class="two-columns">
            <button class="btn btn-success" onclick="sendCampaign('sms')">
              ð± Enviar SMS a Todos
            </button>
            <button class="btn btn-warning" onclick="sendCampaign('call')">
              ð Llamar a Todos
            </button>
          </div>
        </div>
      </div>

      <!-- ð PLANTILLAS -->
      <div class="tab-content" id="tab-templates">
        <h2 style="color: #667eea; margin-bottom: 20px;">ð GestiÃ³n de Plantillas</h2>

        <div class="section">
          <h2>â Crear Nueva Plantilla</h2>
          <div class="form-group">
            <label>Nombre de la Plantilla</label>
            <input type="text" id="templateName" placeholder="Ej: Recordatorio de Pago">
          </div>
          <div class="form-group">
            <label>CompaÃ±Ã­a</label>
            <input type="text" id="templateCompany" placeholder="Ej: Mi Empresa S.A.">
          </div>
          <div class="form-group">
            <label>Mensaje SMS</label>
            <textarea id="templateSMS" placeholder="Usa variables: {Nombre}, {Telefono}, {Deuda}, {CompaÃ±ia}"></textarea>
          </div>
          <div class="form-group">
            <label>Script de Llamada</label>
            <textarea id="templateCall" placeholder="Usa variables: {Nombre}, {Telefono}, {Deuda}, {CompaÃ±ia}"></textarea>
          </div>
          <button class="btn btn-primary" onclick="createTemplate()">
            â Guardar Plantilla
          </button>
        </div>

        <div class="section">
          <h2>ð Mis Plantillas</h2>
          <div id="templatesList">
            <div class="empty-state">
              <div class="empty-state-icon">ð</div>
              <p>No hay plantillas creadas</p>
            </div>
          </div>
        </div>
      </div>

      <!-- â° PROGRAMAR -->
      <div class="tab-content" id="tab-scheduler">
        <h2 style="color: #667eea; margin-bottom: 20px;">â° Programar CampaÃ±as</h2>

        <div class="section">
          <h2>ð Nueva CampaÃ±a Programada</h2>
          <div class="info-box">
            <strong>â¹ï¸ Instrucciones:</strong>
            Programa una campaÃ±a para que se ejecute automÃ¡ticamente en una fecha y hora especÃ­fica.
            Los crÃ©ditos se descontarÃ¡n cuando se ejecute la campaÃ±a.
          </div>
          
          <div class="form-group">
            <label>Nombre de la CampaÃ±a</label>
            <input type="text" id="campaignName" placeholder="Ej: Recordatorio Mensual">
          </div>

          <div class="form-group">
            <label>Seleccionar Plantilla</label>
            <select id="scheduleTemplate">
              <option value="">-- Selecciona una plantilla --</option>
            </select>
          </div>

          <div class="form-group">
            <label>Tipo de CampaÃ±a</label>
            <select id="scheduleType">
              <option value="sms">ð± SMS (1 crÃ©dito por mensaje)</option>
              <option value="call">ð Llamada (2 crÃ©ditos por llamada)</option>
            </select>
          </div>

          <div class="two-columns">
            <div class="form-group">
              <label>Fecha</label>
              <input type="date" id="scheduleDate">
            </div>
            <div class="form-group">
              <label>Hora</label>
              <input type="time" id="scheduleTime">
            </div>
          </div>

          <button class="btn btn-primary btn-full" onclick="scheduleCampaign()">
            â° Programar CampaÃ±a
          </button>
        </div>

        <div class="section">
          <h2>ð CampaÃ±as Programadas</h2>
          <div id="scheduledList">
            <div class="empty-state">
              <div class="empty-state-icon">ð</div>
              <p>No hay campaÃ±as programadas</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ð¥ CLIENTES -->
      <div class="tab-content" id="tab-clients">
        <h2 style="color: #667eea; margin-bottom: 20px;">ð¥ GestiÃ³n de Clientes</h2>

        <!-- Filtros -->
        <div class="filter-section">
          <h2 style="margin-bottom: 15px;">ð Filtros de BÃºsqueda</h2>
          
          <div class="filter-grid">
            <div class="form-group" style="margin-bottom: 0;">
              <label>Estado</label>
              <select id="filterStatus">
                <option value="">Todos</option>
                <option value="pending">Pendiente</option>
                <option value="contacted">Contactado</option>
                <option value="promised">Promesa de Pago</option>
                <option value="paid">Pagado</option>
                <option value="dispute">En Disputa</option>
              </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label>Fecha Desde</label>
              <input type="date" id="filterDateFrom">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label>Fecha Hasta</label>
              <input type="date" id="filterDateTo">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label>Buscar por Nombre</label>
              <input type="text" id="filterName" placeholder="Nombre del cliente...">
            </div>
          </div>

          <div class="filter-actions">
            <button class="btn btn-primary" onclick="applyFilters()">
              ð Aplicar Filtros
            </button>
            <button class="btn btn-warning" onclick="clearFilters()">
              ð Limpiar Filtros
            </button>
            <button class="btn btn-success" onclick="exportToExcel()">
              ð Exportar a Excel
            </button>
            <button class="btn btn-danger" onclick="exportFilteredToExcel()">
              ð¥ Exportar Filtrados
            </button>
          </div>

          <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px; font-size: 0.9em; color: #666;">
            <strong>Total de clientes:</strong> <span id="totalClients">0</span> |
            <strong>Filtrados:</strong> <span id="filteredClients">0</span>
          </div>
        </div>

        <!-- Lista de clientes -->
        <div class="section">
          <h2>ð Lista de Clientes</h2>
          <div id="clientsFullList">
            <div class="empty-state">
              <div class="empty-state-icon">ð¥</div>
              <p>No hay clientes registrados</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ð ESTADÃSTICAS -->
      <div class="tab-content" id="tab-stats">
        <h2 style="color: #667eea; margin-bottom: 20px;">ð EstadÃ­sticas Detalladas</h2>

        <div class="stats-grid">
          <div class="stat-card total">
            <div class="stat-label">ð Total Enviados</div>
            <div class="stat-value" id="statDetailTotal">0</div>
          </div>
          <div class="stat-card success">
            <div class="stat-label">â Exitosos</div>
            <div class="stat-value" id="statDetailSuccess">0</div>
          </div>
          <div class="stat-card error">
            <div class="stat-label">â Errores</div>
            <div class="stat-value" id="statDetailErrors">0</div>
          </div>
          <div class="stat-card pending">
            <div class="stat-label">â³ Pendientes</div>
            <div class="stat-value" id="statDetailPending">0</div>
          </div>
        </div>

        <div class="two-columns">
          <div class="section">
            <h2>ð EstadÃ­sticas de Llamadas</h2>
            <div style="background: white; padding: 20px; border-radius: 10px;">
              <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                <strong>â Contestadas:</strong> <span id="statCallAnswered" style="float: right; font-size: 1.2em; color: #10b981;">0</span>
              </div>
              <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                <strong>â Rechazadas:</strong> <span id="statCallRejected" style="float: right; font-size: 1.2em; color: #ef4444;">0</span>
              </div>
              <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                <strong>ðµ Ocupado:</strong> <span id="statCallBusy" style="float: right; font-size: 1.2em; color: #f59e0b;">0</span>
              </div>
              <div>
                <strong>ð Sin Respuesta:</strong> <span id="statCallNoAnswer" style="float: right; font-size: 1.2em; color: #6b7280;">0</span>
              </div>
            </div>
          </div>

          <div class="section">
            <h2>ð Resumen General</h2>
            <div style="background: white; padding: 20px; border-radius: 10px;">
              <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                <strong>Tasa de Ãxito:</strong> 
                <span id="successRate" style="float: right; font-size: 1.2em; color: #667eea; font-weight: bold;">0%</span>
              </div>
              <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                <strong>Tasa de Error:</strong> 
                <span id="errorRate" style="float: right; font-size: 1.2em; color: #ef4444; font-weight: bold;">0%</span>
              </div>
              <div>
                <strong>Ãltima ActualizaciÃ³n:</strong> 
                <span id="lastUpdate" style="float: right; font-size: 0.9em; color: #666;">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ð LOGS -->
      <div class="tab-content" id="tab-logs">
        <h2 style="color: #667eea; margin-bottom: 20px;">ð Registro de Actividad</h2>

        <div class="section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 style="margin: 0;">ð Logs del Sistema</h2>
            <button class="btn btn-primary" onclick="loadLogs()">
              ð Actualizar
            </button>
          </div>
          <div class="log-container" id="logContainer">
            <div class="log-entry log-info">â¹ï¸ Cargando logs...</div>
          </div>
        </div>
      </div>

      <!-- âï¸ ADMIN -->
      <div class="tab-content admin-only" id="tab-admin" style="display: none;">
        <h2 style="color: #667eea; margin-bottom: 20px;">âï¸ Panel de AdministraciÃ³n</h2>

        <div class="section">
          <h2>â Crear Nuevo Usuario</h2>
          <div class="two-columns">
            <div class="form-group">
              <label>Usuario</label>
              <input type="text" id="newUsername" placeholder="username">
            </div>
            <div class="form-group">
              <label>ContraseÃ±a</label>
              <input type="password" id="newUserPassword" placeholder="********">
            </div>
          </div>
          <div class="two-columns">
            <div class="form-group">
              <label>Nombre Completo</label>
              <input type="text" id="newUserName" placeholder="Juan PÃ©rez">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="newUserEmail" placeholder="usuario@ejemplo.com">
            </div>
          </div>
          <div class="two-columns">
            <div class="form-group">
              <label>CrÃ©ditos Iniciales</label>
              <input type="number" id="newUserCredits" value="100" min="0">
            </div>
            <div class="form-group">
              <label>Rol</label>
              <select id="newUserRole">
                <option value="user">ð¤ Usuario</option>
                <option value="admin">ð Administrador</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary" onclick="createUser()">
            â Crear Usuario
          </button>
        </div>

        <div class="section">
          <h2>ð¥ Usuarios del Sistema</h2>
          <div id="usersList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===================================
    // ð§ CONFIGURACIÃN
    // ===================================
    const API_BASE = window.location.origin + '/api';
    let currentUser = null;
    let loadedClients = [];
    let allClients = [];
    let filteredClients = [];

    // ===================================
    // ð AUTENTICACIÃN
    // ===================================
    async function login(event) {
      event.preventDefault();
      
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const errorDiv = document.getElementById('loginError');

      try {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (data.success) {
          currentUser = data.user;
          sessionStorage.setItem('current_user', JSON.stringify(currentUser));
          showMainScreen();
        } else {
          errorDiv.textContent = 'â ' + (data.error || 'Credenciales invÃ¡lidas');
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        errorDiv.textContent = 'â Error de conexiÃ³n con el servidor';
        errorDiv.style.display = 'block';
      }
    }

    function showMainScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainScreen').style.display = 'block';
      
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'ð Admin' : 'ð¤ Usuario';
      document.getElementById('userCredits').textContent = currentUser.credits;

      // Mostrar tab de admin si es admin
      if (currentUser.role === 'admin') {
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
      }

      // Cargar datos iniciales
      loadTemplates();
      loadStats();
      loadLogs();
      loadAllClients();
      
      if (currentUser.role === 'admin') {
        loadUsers();
      }
    }

    function logout() {
      sessionStorage.removeItem('current_user');
      currentUser = null;
      loadedClients = [];
      allClients = [];
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainScreen').style.display = 'none';
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
      document.getElementById('loginError').style.display = 'none';
    }

    // ===================================
    // ð TABS
    // ===================================
    function showTab(tabName) {
      // Ocultar todos los tabs
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      // Mostrar tab seleccionado
      event.target.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // Cargar datos especÃ­ficos del tab
      if (tabName === 'templates') loadTemplates();
      if (tabName === 'scheduler') {
        loadTemplates();
        loadScheduledCampaigns();
      }
      if (tabName === 'stats') loadDetailedStats();
      if (tabName === 'logs') loadLogs();
      if (tabName === 'admin' && currentUser.role === 'admin') loadUsers();
      if (tabName === 'campaigns') loadTemplates();
      if (tabName === 'clients') {
        loadAllClients();
      }
      if (tabName === 'dashboard') {
        loadStats();
        loadLogs().then(() => {
          const logs = document.getElementById('logContainer').innerHTML;
          document.getElementById('dashboardLogs').innerHTML = logs;
        });
      }
    }

    // ===================================
    // ð PLANTILLAS
    // ===================================
    async function loadTemplates() {
      try {
        const response = await fetch(`${API_BASE}/templates/${currentUser.username}`);
        const data = await response.json();

        if (data.success) {
          const templates = data.templates;
          
          // Actualizar lista de plantillas
          const list = document.getElementById('templatesList');
          if (templates.length === 0) {
            list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ð</div><p>No hay plantillas creadas</p></div>';
          } else {
            list.innerHTML = templates.map(t => `
              <div class="template-card">
                <div class="template-header">
                  <div>
                    <div class="template-title">${t.name}</div>
                    <div class="template-company">ð¢ ${t.company}</div>
                  </div>
                  <button class="btn btn-danger" onclick="deleteTemplate('${t._id}')" style="padding: 8px 15px;">
                    ðï¸ Eliminar
                  </button>
                </div>
                ${t.smsMessage ? `
                  <div class="template-content">
                    <h4>ð± Mensaje SMS:</h4>
                    <p>${t.smsMessage}</p>
                  </div>
                ` : ''}
                ${t.callScript ? `
                  <div class="template-content">
                    <h4>ð Script de Llamada:</h4>
                    <p>${t.callScript}</p>
                  </div>
                ` : ''}
              </div>
            `).join('');
          }

          // Actualizar selectores
          const selectors = ['campaignTemplate', 'scheduleTemplate'];
          selectors.forEach(selectorId => {
            const selector = document.getElementById(selectorId);
            if (selector) {
              selector.innerHTML = '<option value="">-- Selecciona una plantilla --</option>' +
                templates.map(t => `<option value="${t._id}">${t.name} (${t.company})</option>`).join('');
            }
          });
        }
      } catch (error) {
        console.error('Error cargando plantillas:', error);
      }
    }

    async function createTemplate() {
      const template = {
        username: currentUser.username,
        name: document.getElementById('templateName').value,
        company: document.getElementById('templateCompany').value,
        smsMessage: document.getElementById('templateSMS').value,
        callScript: document.getElementById('templateCall').value
      };

      if (!template.name || !template.company) {
        alert('Completa al menos el nombre y la compaÃ±Ã­a');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/templates`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(template)
        });

        const data = await response.json();
        if (data.success) {
          loadTemplates();
          addLog(`Plantilla "${template.name}" creada`, 'success');
          document.getElementById('templateName').value = '';
          document.getElementById('templateCompany').value = '';
          document.getElementById('templateSMS').value = '';
          document.getElementById('templateCall').value = '';
        }
      } catch (error) {
        addLog('Error creando plantilla', 'error');
      }
    }

    async function deleteTemplate(id) {
      if (!confirm('Â¿Eliminar esta plantilla?')) return;

      try {
        await fetch(`${API_BASE}/templates/${id}`, { method: 'DELETE' });
        loadTemplates();
        addLog('Plantilla eliminada', 'info');
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // ===================================
    // ð± CAMPAÃAS
    // ===================================
    function loadCSV() {
      const file = document.getElementById('csvFile').files[0];
      if (!file) {
        alert('Selecciona un archivo CSV');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
          alert('El archivo estÃ¡ vacÃ­o o no tiene datos');
          return;
        }

        const headers = lines[0].split(',').map(h => h.trim());
        loadedClients = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim());
          if (values.length >= 4) {
            loadedClients.push({
              Nombre: values[0],
              Telefono: values[1],
              Deuda: values[2],
              CompaÃ±ia: values[3]
            });
          }
        }

        displayLoadedClients();
        addLog(`${loadedClients.length} clientes cargados desde CSV`, 'success');
      };

      reader.readAsText(file);
    }

    function displayLoadedClients() {
      const container = document.getElementById('clientsList');
      const count = document.getElementById('clientCount');
      
      count.textContent = loadedClients.length;

      if (loadedClients.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ð</div><p>No hay clientes cargados</p></div>';
        return;
      }

      container.innerHTML = loadedClients.map((client, index) => `
        <div class="client-card">
          <div class="client-header">
            <div>
              <div class="client-name">${client.Nombre}</div>
              <div class="client-info">
                ð ${client.Telefono} â¢ ð° $${client.Deuda} â¢ ð¢ ${client.CompaÃ±ia}
              </div>
            </div>
            <button class="btn btn-danger" onclick="removeClient(${index})" style="padding: 8px 15px;">
              ðï¸
            </button>
          </div>
        </div>
      `).join('');
    }

    function removeClient(index) {
      loadedClients.splice(index, 1);
      displayLoadedClients();
    }

    async function sendCampaign(type) {
      const templateId = document.getElementById('campaignTemplate').value;
      
      if (!templateId) {
        alert('Selecciona una plantilla');
        return;
      }

      if (loadedClients.length === 0) {
        alert('Primero carga clientes desde un CSV');
        return;
      }

      const costPerMessage = type === 'sms' ? 1 : 2;
      const totalCost = loadedClients.length * costPerMessage;

      if (currentUser.credits < totalCost) {
        alert(`â CrÃ©ditos insuficientes.\n\nNecesitas: ${totalCost} crÃ©ditos\nTienes: ${currentUser.credits}`);
        return;
      }

      if (!confirm(`Â¿Enviar ${type === 'sms' ? 'SMS' : 'llamadas'} a ${loadedClients.length} clientes?\n\nCosto: ${totalCost} crÃ©ditos`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/campaigns/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username,
            templateId,
            type,
            clients: loadedClients
          })
        });

        const data = await response.json();
        if (data.success) {
          addLog(`CampaÃ±a enviada: ${data.results.success} exitosos, ${data.results.errors} errores`, 'success');
          
          // Actualizar crÃ©ditos
          currentUser.credits = data.creditsRemaining;
          document.getElementById('userCredits').textContent = currentUser.credits;
          sessionStorage.setItem('current_user', JSON.stringify(currentUser));
          
          loadStats();
        }
      } catch (error) {
        addLog('Error enviando campaÃ±a', 'error');
      }
    }

    // ===================================
    // â° SCHEDULER
    // ===================================
    async function scheduleCampaign() {
      const name = document.getElementById('campaignName').value;
      const templateId = document.getElementById('scheduleTemplate').value;
      const type = document.getElementById('scheduleType').value;
      const date = document.getElementById('scheduleDate').value;
      const time = document.getElementById('scheduleTime').value;

      if (!name || !templateId || !date || !time) {
        alert('Completa todos los campos');
        return;
      }

      if (loadedClients.length === 0) {
        alert('Primero carga clientes desde la pestaÃ±a CampaÃ±as');
        return;
      }

      const scheduledDate = new Date(`${date}T${time}`);
      if (scheduledDate < new Date()) {
        alert('La fecha debe ser futura');
        return;
      }

      // Guardar clientes en la base de datos primero
      try {
        const saveResponse = await fetch(`${API_BASE}/clients/bulk`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username,
            clients: loadedClients
          })
        });

        const saveData = await saveResponse.json();
        if (!saveData.success) {
          alert('Error guardando clientes');
          return;
        }

        const clientIds = saveData.clientIds;
        const costPerMessage = type === 'sms' ? 1 : 2;
        const totalCost = clientIds.length * costPerMessage;

        if (currentUser.credits < totalCost) {
          alert(`â CrÃ©ditos insuficientes.\n\nSe necesitarÃ¡n ${totalCost} crÃ©ditos cuando se ejecute.\nTienes: ${currentUser.credits}`);
          return;
        }

        const response = await fetch(`${API_BASE}/scheduled-campaigns`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username,
            name,
            templateId,
            type,
            scheduledDate: scheduledDate.toISOString(),
            clientIds
          })
        });

        const data = await response.json();
        if (data.success) {
          addLog(`â CampaÃ±a "${name}" programada para ${scheduledDate.toLocaleString('es-MX')}`, 'success');
          document.getElementById('campaignName').value = '';
          document.getElementById('scheduleDate').value = '';
          document.getElementById('scheduleTime').value = '';
          loadScheduledCampaigns();
        }
      } catch (error) {
        addLog('Error programando campaÃ±a', 'error');
      }
    }

    async function loadScheduledCampaigns() {
      try {
        const response = await fetch(`${API_BASE}/scheduled-campaigns/${currentUser.username}`);
        const data = await response.json();

        if (data.success) {
          const campaigns = data.campaigns;
          const list = document.getElementById('scheduledList');

          if (campaigns.length === 0) {
            list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ð</div><p>No hay campaÃ±as programadas</p></div>';
          } else {
            list.innerHTML = campaigns.map(c => {
              const scheduledDate = new Date(c.scheduledDate);
              const statusClass = `status-${c.status}`;
              const statusText = {
                scheduled: 'â° Programada',
                running: 'â¶ï¸ Ejecutando',
                completed: 'â Completada',
                cancelled: 'â Cancelada'
              }[c.status];

              return `
                <div class="campaign-card">
                  <div class="campaign-header">
                    <div>
                      <div class="campaign-title">${c.name}</div>
                      <div class="campaign-meta">
                        ð ${scheduledDate.toLocaleDateString('es-MX')} a las ${scheduledDate.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' })}
                        <br>
                        ${c.type === 'sms' ? 'ð± SMS' : 'ð Llamada'} â¢ ${c.results.total} clientes
                        ${c.status === 'completed' ? `â¢ ${c.results.success} exitosos, ${c.results.errors} errores` : ''}
                      </div>
                    </div>
                    <span class="campaign-status ${statusClass}">${statusText}</span>
                  </div>
                  ${c.status === 'scheduled' ? `
                    <div class="campaign-actions">
                      <button class="btn btn-danger" onclick="cancelCampaign('${c._id}')" style="padding: 8px 15px; font-size: 0.9em;">
                        ðï¸ Cancelar
                      </button>
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('');
          }
        }
      } catch (error) {
        console.error('Error cargando campaÃ±as programadas:', error);
      }
    }

    async function cancelCampaign(id) {
      if (!confirm('Â¿Cancelar esta campaÃ±a?')) return;

      try {
        await fetch(`${API_BASE}/scheduled-campaigns/${id}`, { method: 'DELETE' });
        loadScheduledCampaigns();
        addLog('CampaÃ±a cancelada', 'info');
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // ===================================
    // ð¥ GESTIÃN DE CLIENTES
    // ===================================
    async function loadAllClients() {
      try {
        const response = await fetch(`${API_BASE}/clients/${currentUser.username}`);
        const data = await response.json();

        if (data.success) {
          allClients = data.clients;
          filteredClients = [...allClients];
          displayAllClients();
        }
      } catch (error) {
        console.error('Error cargando clientes:', error);
      }
    }

    function displayAllClients() {
      const container = document.getElementById('clientsFullList');
      document.getElementById('totalClients').textContent = allClients.length;
      document.getElementById('filteredClients').textContent = filteredClients.length;

      if (filteredClients.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ð¥</div><p>No hay clientes que coincidan con los filtros</p></div>';
        return;
      }

      container.innerHTML = filteredClients.map(client => {
        const statusClass = `status-${client.status}`;
        const statusText = {
          pending: 'â³ Pendiente',
          contacted: 'ð Contactado',
          promised: 'ð¤ Promesa de Pago',
          paid: 'â Pagado',
          dispute: 'â ï¸ En Disputa'
        }[client.status];

        const lastContact = client.lastContact 
          ? new Date(client.lastContact).toLocaleDateString('es-MX')
          : 'Nunca';

        return `
          <div class="client-card">
            <div class="client-header">
              <div>
                <div class="client-name">${client.name}</div>
                <div class="client-info">
                  ð ${client.phone} â¢ ð° $${client.debt} ${client.company ? `â¢ ð¢ ${client.company}` : ''}
                  <br>
                  ð Ãltimo contacto: ${lastContact} â¢ Agregado: ${new Date(client.createdAt).toLocaleDateString('es-MX')}
                </div>
                ${client.notes ? `<div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">ð ${client.notes}</div>` : ''}
              </div>
              <span class="status-badge ${statusClass}">${statusText}</span>
            </div>
            <div class="client-actions">
              <button class="btn btn-primary" onclick="updateClientStatus('${client._id}')">
                ð Cambiar Estado
              </button>
              <button class="btn btn-warning" onclick="addClientNote('${client._id}')">
                ð AÃ±adir Nota
              </button>
              <button class="btn btn-danger" onclick="deleteClient('${client._id}')">
                ðï¸ Eliminar
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function applyFilters() {
      const status = document.getElementById('filterStatus').value;
      const dateFrom = document.getElementById('filterDateFrom').value;
      const dateTo = document.getElementById('filterDateTo').value;
      const name = document.getElementById('filterName').value.toLowerCase();

      filteredClients = allClients.filter(client => {
        // Filtro por estado
        if (status && client.status !== status) return false;

        // Filtro por nombre
        if (name && !client.name.toLowerCase().includes(name)) return false;

        // Filtro por rango de fechas (fecha de creaciÃ³n)
        if (dateFrom || dateTo) {
          const clientDate = new Date(client.createdAt);
          
          if (dateFrom) {
            const fromDate = new Date(dateFrom);
            fromDate.setHours(0, 0, 0, 0);
            if (clientDate < fromDate) return false;
          }
          
          if (dateTo) {
            const toDate = new Date(dateTo);
            toDate.setHours(23, 59, 59, 999);
            if (clientDate > toDate) return false;
          }
        }

        return true;
      });

      displayAllClients();
      addLog(`Filtros aplicados: ${filteredClients.length} de ${allClients.length} clientes`, 'info');
    }

    function clearFilters() {
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterDateFrom').value = '';
      document.getElementById('filterDateTo').value = '';
      document.getElementById('filterName').value = '';
      
      filteredClients = [...allClients];
      displayAllClients();
      addLog('Filtros limpiados', 'info');
    }

    async function updateClientStatus(clientId) {
      const newStatus = prompt('Nuevo estado:\n\npending = Pendiente\ncontacted = Contactado\npromised = Promesa de Pago\npaid = Pagado\ndispute = En Disputa\n\nIngresa uno de los valores:');
      
      if (!newStatus) return;
      
      const validStatuses = ['pending', 'contacted', 'promised', 'paid', 'dispute'];
      if (!validStatuses.includes(newStatus)) {
        alert('Estado invÃ¡lido');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/clients/${clientId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });

        const data = await response.json();
        if (data.success) {
          loadAllClients();
          addLog('Estado del cliente actualizado', 'success');
        }
      } catch (error) {
        addLog('Error actualizando cliente', 'error');
      }
    }

    async function addClientNote(clientId) {
      const note = prompt('AÃ±adir nota al cliente:');
      if (!note) return;

      try {
        const response = await fetch(`${API_BASE}/clients/${clientId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes: note })
        });

        const data = await response.json();
        if (data.success) {
          loadAllClients();
          addLog('Nota aÃ±adida al cliente', 'success');
        }
      } catch (error) {
        addLog('Error aÃ±adiendo nota', 'error');
      }
    }

    async function deleteClient(clientId) {
      if (!confirm('Â¿Eliminar este cliente?')) return;

      try {
        await fetch(`${API_BASE}/clients/${clientId}`, { method: 'DELETE' });
        loadAllClients();
        addLog('Cliente eliminado', 'info');
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // ===================================
    // ð EXPORTAR A EXCEL
    // ===================================
    function exportToExcel() {
      if (allClients.length === 0) {
        alert('No hay clientes para exportar');
        return;
      }

      exportClientsToExcel(allClients, 'todos_los_clientes');
    }

    function exportFilteredToExcel() {
      if (filteredClients.length === 0) {
        alert('No hay clientes filtrados para exportar');
        return;
      }

      exportClientsToExcel(filteredClients, 'clientes_filtrados');
    }

    function exportClientsToExcel(clients, filename) {
      // Preparar datos para Excel
      const excelData = clients.map(client => ({
        'Nombre': client.name,
        'TelÃ©fono': client.phone,
        'Deuda': client.debt,
        'CompaÃ±Ã­a': client.company || '',
        'Estado': {
          pending: 'Pendiente',
          contacted: 'Contactado',
          promised: 'Promesa de Pago',
          paid: 'Pagado',
          dispute: 'En Disputa'
        }[client.status],
        'Ãltimo Contacto': client.lastContact 
          ? new Date(client.lastContact).toLocaleDateString('es-MX')
          : 'Nunca',
        'Fecha de Registro': new Date(client.createdAt).toLocaleDateString('es-MX'),
        'Notas': client.notes || ''
      }));

      // Crear libro de Excel
      const ws = XLSX.utils.json_to_sheet(excelData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Clientes');

      // Ajustar ancho de columnas
      const colWidths = [
        { wch: 25 }, // Nombre
        { wch: 15 }, // TelÃ©fono
        { wch: 12 }, // Deuda
        { wch: 20 }, // CompaÃ±Ã­a
        { wch: 18 }, // Estado
        { wch: 18 }, // Ãltimo Contacto
        { wch: 18 }, // Fecha Registro
        { wch: 40 }  // Notas
      ];
      ws['!cols'] = colWidths;

      // Descargar archivo
      const timestamp = new Date().toISOString().slice(0, 10);
      XLSX.writeFile(wb, `${filename}_${timestamp}.xlsx`);

      addLog(`Excel exportado: ${clients.length} clientes`, 'success');
    }

    // ===================================
    // ð ESTADÃSTICAS
    // ===================================
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/stats/${currentUser.username}`);
        const data = await response.json();

        if (data.success) {
          const stats = data.stats;
          document.getElementById('statTotal').textContent = stats.total;
          document.getElementById('statSuccess').textContent = stats.success;
          document.getElementById('statErrors').textContent = stats.errors;
          document.getElementById('statPending').textContent = stats.pending;
        }
      } catch (error) {
        console.error('Error cargando estadÃ­sticas:', error);
      }
    }

    async function loadDetailedStats() {
      try {
        const response = await fetch(`${API_BASE}/stats/${currentUser.username}`);
        const data = await response.json();

        if (data.success) {
          const stats = data.stats;
          
          document.getElementById('statDetailTotal').textContent = stats.total;
          document.getElementById('statDetailSuccess').textContent = stats.success;
          document.getElementById('statDetailErrors').textContent = stats.errors;
          document.getElementById('statDetailPending').textContent = stats.pending;
          
          document.getElementById('statCallAnswered').textContent = stats.callAnswered || 0;
          document.getElementById('statCallRejected').textContent = stats.callRejected || 0;
          document.getElementById('statCallBusy').textContent = stats.callBusy || 0;
          document.getElementById('statCallNoAnswer').textContent = stats.callNoAnswer || 0;

          // Calcular tasas
          const successRate = stats.total > 0 
            ? ((stats.success / stats.total) * 100).toFixed(1)
            : 0;
          const errorRate = stats.total > 0 
            ? ((stats.errors / stats.total) * 100).toFixed(1)
            : 0;

          document.getElementById('successRate').textContent = `${successRate}%`;
          document.getElementById('errorRate').textContent = `${errorRate}%`;

          const lastUpdate = stats.lastUpdated 
            ? new Date(stats.lastUpdated).toLocaleString('es-MX')
            : 'Nunca';
          document.getElementById('lastUpdate').textContent = lastUpdate;
        }
      } catch (error) {
        console.error('Error cargando estadÃ­sticas detalladas:', error);
      }
    }

    // ===================================
    // ð LOGS
    // ===================================
    async function loadLogs() {
      try {
        const response = await fetch(`${API_BASE}/logs/${currentUser.username}`);
        const data = await response.json();

        if (data.success) {
          const container = document.getElementById('logContainer');
          if (data.logs.length === 0) {
            container.innerHTML = '<div class="log-entry log-info">â¹ï¸ Sistema iniciado</div>';
          } else {
            container.innerHTML = data.logs.map(log => {
              const time = new Date(log.timestamp).toLocaleTimeString('es-MX');
              const date = new Date(log.timestamp).toLocaleDateString('es-MX');
              return `<div class="log-entry log-${log.type}">[${date} ${time}] ${log.message}</div>`;
            }).join('');
          }
        }
      } catch (error) {
        console.error('Error cargando logs:', error);
      }
    }

    async function addLog(message, type = 'info') {
      try {
        await fetch(`${API_BASE}/logs`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username,
            message,
            type
          })
        });
        loadLogs();
      } catch (error) {
        console.error('Error guardando log:', error);
      }
    }

    // ===================================
    // ð¥ ADMINISTRACIÃN
    // ===================================
    async function loadUsers() {
      try {
        const response = await fetch(`${API_BASE}/users`);
        const data = await response.json();

        if (data.success) {
          const list = document.getElementById('usersList');
          list.innerHTML = data.users.map(u => `
            <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${u.name}</strong> (${u.username})
                <div style="color: #666; font-size: 0.9em; margin-top: 5px;">
                  ${u.email} â¢ ${u.role === 'admin' ? 'ð Admin' : 'ð¤ Usuario'} â¢ ð³ ${u.credits} crÃ©ditos
                </div>
              </div>
              ${u.username !== 'admin' ? `
                <button class="btn btn-danger" onclick="deleteUser('${u.username}')" style="padding: 8px 15px;">
                  ðï¸ Eliminar
                </button>
              ` : ''}
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Error cargando usuarios:', error);
      }
    }

    async function createUser() {
      const user = {
        username: document.getElementById('newUsername').value,
        password: document.getElementById('newUserPassword').value,
        name: document.getElementById('newUserName').value,
        email: document.getElementById('newUserEmail').value,
        credits: parseInt(document.getElementById('newUserCredits').value),
        role: document.getElementById('newUserRole').value
      };

      if (!user.username || !user.password || !user.name || !user.email) {
        alert('Completa todos los campos');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(user)
        });

        const data = await response.json();
        if (data.success) {
          loadUsers();
          addLog(`Usuario ${user.username} creado`, 'success');
          document.getElementById('newUsername').value = '';
          document.getElementById('newUserPassword').value = '';
          document.getElementById('newUserName').value = '';
          document.getElementById('newUserEmail').value = '';
          document.getElementById('newUserCredits').value = '100';
        } else {
          alert(data.error);
        }
      } catch (error) {
        addLog('Error creando usuario', 'error');
      }
    }

    async function deleteUser(username) {
      if (!confirm(`Â¿Eliminar usuario ${username}?`)) return;

      try {
        await fetch(`${API_BASE}/users/${username}`, { method: 'DELETE' });
        loadUsers();
        addLog(`Usuario ${username} eliminado`, 'info');
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // ===================================
    // ð INICIALIZAR
    // ===================================
    window.onload = function() {
      const sessionUser = sessionStorage.getItem('current_user');
      if (sessionUser) {
        currentUser = JSON.parse(sessionUser);
        showMainScreen();
      }
      
      // Establecer fecha y hora mÃ­nima (ahora)
      const now = new Date();
      const today = now.toISOString().split('T')[0];
      const currentTime = now.toTimeString().slice(0, 5);
      
      const scheduleDate = document.getElementById('scheduleDate');
      const scheduleTime = document.getElementById('scheduleTime');
      
      if (scheduleDate && scheduleTime) {
        scheduleDate.min = today;
        scheduleDate.value = today;
        scheduleTime.value = currentTime;
      }
    };
  </script>
</body>
</html>